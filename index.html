<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giám Sát Sức Khỏe MAX30102 - Liquid Glass</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    
</head>
<body>
    <div class="container">
        <h1>Giám Sát Sức Khỏe MAX30102</h1>
        <div class="data-card">
            <svg viewBox="0 0 24 24" fill="none" stroke="#ff6b6b" stroke-width="2">
                <path d="M12 20s-8-4-8-10c0-4 3-7 8-7s8 3 8 7c0 6-8 10-8 10zm0-14l3 4h-6l3-4z"/>
            </svg>
            <p>Nhịp Tim: <span id="heart-rate" class="value">--</span> bpm</p>
        </div>
        <div class="data-card">
            <svg viewBox="0 0 24 24" fill="none" stroke="#ff6b6b" stroke-width="2">
                <path d="M12 21a9 9 0 100-18 9 9 0 000 18zm0-4a5 5 0 110-10 5 5 0 010 10z"/>
            </svg>
            <p>SpO2: <span id="spo2" class="value">--</span> %</p>
        </div>
        <div class="tabs">
            <div class="tab active" onclick="showChart('heartRate')">Nhịp Tim</div>
            <div class="tab" onclick="showChart('spo2')">SpO2</div>
        </div>
        <div class="chart-container active" id="heartRateChartContainer">
            <canvas id="heartRateChart"></canvas>
        </div>
        <div class="chart-container" id="spo2ChartContainer">
            <canvas id="spo2Chart"></canvas>
        </div>
        <p id="status" class="status">Đang kết nối...</p>
    </div>

    <script>
        // Khởi tạo Chart.js cho nhịp tim
        const heartRateCtx = document.getElementById('heartRateChart').getContext('2d');
        const heartRateChart = new Chart(heartRateCtx, {
            type: 'line',
            data: {
                labels: Array(20).fill(''),
                datasets: [{
                    label: 'Nhịp Tim (BPM)',
                    data: [],
                    borderColor: '#ff6b6b',
                    backgroundColor: 'rgba(255, 107, 107, 0.2)',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 3,
                    pointBackgroundColor: '#ff6b6b',
                    borderWidth: 2
                }]
            },
            options: {
                scales: {
                    x: { display: false },
                    y: { 
                        beginAtZero: false,
                        suggestedMin: 50,
                        suggestedMax: 120,
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    }
                },
                plugins: {
                    legend: { display: false },
                    title: { 
                        display: true,
                        text: 'Biểu đồ Nhịp Tim',
                        color: 'rgba(255, 255, 255, 0.9)',
                        font: { size: 14 }
                    }
                },
                animation: {
                    duration: 1000,
                    easing: 'easeOutCubic'
                }
            }
        });

        // Khởi tạo Chart.js cho SpO2
        const spo2Ctx = document.getElementById('spo2Chart').getContext('2d');
        const spo2Chart = new Chart(spo2Ctx, {
            type: 'line',
            data: {
                labels: Array(20).fill(''),
                datasets: [{
                    label: 'SpO2 (%)',
                    data: [],
                    borderColor: '#4ade80',
                    backgroundColor: 'rgba(74, 222, 128, 0.2)',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 3,
                    pointBackgroundColor: '#4ade80',
                    borderWidth: 2
                }]
            },
            options: {
                scales: {
                    x: { display: false },
                    y: { 
                        beginAtZero: false,
                        suggestedMin: 90,
                        suggestedMax: 100,
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    }
                },
                plugins: {
                    legend: { display: false },
                    title: { 
                        display: true,
                        text: 'Biểu đồ SpO2',
                        color: 'rgba(255, 255, 255, 0.9)',
                        font: { size: 14 }
                    }
                },
                animation: {
                    duration: 1000,
                    easing: 'easeOutCubic'
                }
            }
        });

        // Hàm chuyển đổi tab
        function showChart(chartType) {
            const heartRateContainer = document.getElementById('heartRateChartContainer');
            const spo2Container = document.getElementById('spo2ChartContainer');
            const tabs = document.querySelectorAll('.tab');

            tabs.forEach(tab => tab.classList.remove('active'));
            if (chartType === 'heartRate') {
                heartRateContainer.classList.add('active');
                spo2Container.classList.remove('active');
                tabs[0].classList.add('active');
            } else {
                spo2Container.classList.add('active');
                heartRateContainer.classList.remove('active');
                tabs[1].classList.add('active');
            }
        }

        // WebSocket logic
        const heartRateElement = document.getElementById('heart-rate');
        const spo2Element = document.getElementById('spo2');
        const statusElement = document.getElementById('status');
        const socket = new WebSocket('ws://192.168.137.1:3030');

        socket.onopen = function(event) {
            console.log('Đã kết nối với máy chủ WebSocket.');
            statusElement.textContent = 'Đã kết nối';
            statusElement.className = 'status connected';
        };

        socket.onmessage = function(event) {
            console.log('Dữ liệu từ máy chủ:', event.data);
            const data = event.data;
            const parts = data.split(':');
            
            if (parts.length >= 2) {
                const heartRate = parseFloat(parts[0]);
                const spo2 = parseFloat(parts[1]);
                
                // Cập nhật giá trị văn bản
                heartRateElement.textContent = heartRate;
                spo2Element.textContent = spo2;
                heartRateElement.style.animation = 'liquidPulse 1s ease-in-out';
                spo2Element.style.animation = 'liquidPulse 1s ease-in-out';
                setTimeout(() => {
                    heartRateElement.style.animation = '';
                    spo2Element.style.animation = '';
                }, 1000);

                // Cập nhật đồ thị
                if (!isNaN(heartRate)) {
                    heartRateChart.data.datasets[0].data.push(heartRate);
                    if (heartRateChart.data.datasets[0].data.length > 20) {
                        heartRateChart.data.datasets[0].data.shift();
                    }
                    heartRateChart.update();
                }
                if (!isNaN(spo2)) {
                    spo2Chart.data.datasets[0].data.push(spo2);
                    if (spo2Chart.data.datasets[0].data.length > 20) {
                        spo2Chart.data.datasets[0].data.shift();
                    }
                    spo2Chart.update();
                }
            }
        };

        socket.onclose = function(event) {
            console.log('Mất kết nối với máy chủ WebSocket.');
            statusElement.textContent = 'Mất kết nối';
            statusElement.className = 'status disconnected';
        };

        socket.onerror = function(error) {
            console.error('Lỗi WebSocket:', error);
            statusElement.textContent = 'Lỗi kết nối';
            statusElement.className = 'status error';
        };
    </script>
</body>
</html>